{% extends "f7/base.html" %}
{% load static %}
{% load jsonify %}

{% block page_content %}
<script src='{% static "js/ex_inputs.pack.js?t=12345" %}'></script>


<script type="text/javascript">

    ff.pop_menu(function(){
        var buttons = [
            {
                text: '新建部门',
                onClick: function () {
                    table.$refs.catalog.dir_create();
                }
            },
        ];
        if(table.state.has_select){
            buttons.push({
                text: '删除选中项',
                onClick: function () {
                    table.$refs.catalog.item_del()
                }
            })
        }
        if(table.state.can_cut){
            buttons.push({
                text: '剪切',
                onClick: function () {
                    table.$refs.catalog.cut()
                }
            })
        }
        if(table.state.can_paste){
            buttons.push({
                text: '粘贴',
                onClick: function () {
                    table.$refs.catalog.paste()
                }
            })
        }

        buttons.push({
            text: '取消',
            color: 'red',
        })
        ff.app.actions(buttons)
    })




    bus=new Vue()

    heads={{ heads | jsonify }}
    department_url = "{% url 'organize.department' %}"
    depart_layer_tree = "{% url 'organize.tree_depart' %}"

    dk_manager=new BackOps(depart_layer_tree)


    $(function () {
        table=new Vue({
            el:'#there',
            data:{

//                crt_view:'main',
                crt_name:'',

                ex:ex,
//                is_show_menu:false,
//                in_wx_agent:in_wx_agent,
                state:{},
                department_url:department_url,

                rows:[],

                root:{pk:null,name:'公司'},
                parents:[],
                items:[]

            },
            mixins:[field_fun],
            mounted:function(){
                this.$refs.catalog.dir_data()

                var self=this
                dk_manager.dir_data({root:this.root,par:this.root},function(resp){
                    self.parents=resp.parents
                    self.items=resp.items

                })
//                var self=this
//                bus.$on('menu_click',function(){
//                    self.is_show_menu=true
//                })
//                var self=this
//                Vue.nextTick(function(){
//                    setTimeout(function(){
//                        self.$refs.scroller.refresh()
//                    },500)
//
//                })
            },
            methods:{

                set_state:function(state){
                    for(var k in state){
                        Vue.set(this.state,k,state[k])
                    }
                },
                after_sub:function(){
                    location=document.referrer
                },

                item_save:function(){
                    var self=this
                    show_upload()
                    var post_data=[{fun:'save',row:this.kw.row}]
                    ex.post('/_ajax',JSON.stringify(post_data),function(resp){
                        if(resp.save.errors){
                            self.kw.errors=resp.save.errors
                        }else{
                            self.kw.errors={}
//                            self.crt_view='main'
                            self.$refs.catalog.selected=[]
                            history.back()
//                            self.selected=[]
                        }
                        hide_upload(200)

                    })
                },

                edit:function(item){
                    this.rows=[item]
                    var url=ex.template('{engine_url}/{page_name}.edit?pk={pk}',{
                        engine_url:engine_url,
                        page_name:page_name,
                        pk:item.pk
                    })
                    ff.load(url,page_name+'_edit')
//                    ln.pushState({op:'edit_aa',arg:item,crt_view:'editor'})
                },
                edit_aa:function(item){
                    this.kw.row=item
                },
                show:function(v){
                    alert(v)
                },

                dir_data:function(item){
                    var self=this
                    dk_manager.dir_data({root:this.root,par:item},function(resp){
                        self.parents=resp.parents
                        self.items=resp.items

                    })
                }
            },

        })
    })

</script>



<div id='there' class="flex-grow" v-cloak style="position: relative;">

    <div class="scroll-wraper">



        <ul>
            <li v-for="par in parents">
                <span v-text="par._label"></span>
            </li>
        </ul>
        <ul>
            <li v-for="item in items">
                <span v-text="item._label" @click="dir_data(item)"></span>
            </li>
        </ul>



        <!--<scroll-wraper class="main-content" ref="scroller" style="width: 100vw;height:90vh;">-->
        <com-catalog class="mobile" ref="catalog" :url="department_url" :root="{pk:null,name:'公司'}"
                     @state_change="set_state($event)" :editable="true">


            <template scope="box" slot="check_sel">
                <div @click="box.toggle_check(box.value)" >
                    <i  v-if="ex.isin(box.value,box.selected)" class="fa fa-circle" aria-hidden="true"></i>
                    <i  v-else  class="fa fa-circle-o" aria-hidden="true"></i>
                </div>

            </template>


            <!--<div slot="head_end" style="text-align: right;padding: 0.5em 1em;" v-if="in_wx_agent">-->
                <!--<i class="fa fa-align-justify fa-2x" aria-hidden="true" @click="is_show_menu=true"></i>-->
            <!--</div>-->

            <template scope="dir_icon">
                <span></span>
                <!--<i class="fa fa-folder fa-2x" aria-hidden="true"></i>-->
            </template>

            <template scope="box" slot="item_icon">
                <i  class="fa fa-file-o fa-2x" aria-hidden="true"></i>
            </template>

            <template slot="btn-panel" scope="box">
                    <span style="color: #0092F2;margin-right: 2em;padding: 0.1em;">
                        <i v-if="ex.isin(box.item,box.selected)" @click="edit(box.item)"  class="fa fa-pencil-square-o" aria-hidden="true"></i>
                    </span>

            </template>

        </com-catalog>
        <!--</scroll-wraper>-->

        <!--@click.native="show_menu=false"-->

        <!--<transition name="fade">-->
            <!--<modal v-show="is_show_menu" id="pop-menu">-->
                <!--<div class="weui-actionsheet__menu" @click.stop="" style="width: 80vw;" v-if="can_edit">-->
                    <!--<div class="weui-actionsheet__cell" @click="edit($refs.catalog.selected[0]);is_show_menu=false" v-show="state.has_select">编辑</div>-->

                    <!--<div class="weui-actionsheet__cell" @click="$refs.catalog.dir_create();is_show_menu=false">新建部门</div>-->
                    <!--&lt;!&ndash;<div class="weui-actionsheet__cell" @click="$refs.catalog.item_create();show_menu=false" v-if="work_can_add">新建工时</div>&ndash;&gt;-->
                    <!--<div class="weui-actionsheet__cell" @click="$refs.catalog.item_del();is_show_menu=false" v-show="state.has_select">删除选中项</div>-->
                    <!--<div class="weui-actionsheet__cell" @click="$refs.catalog.cut();is_show_menu=false" v-show="state.can_cut">剪切</div>-->
                    <!--<div class="weui-actionsheet__cell" @click="$refs.catalog.paste();is_show_menu=false" v-show="state.can_paste">粘贴</div>-->
                <!--</div>-->
                <!--<div class="weui-actionsheet__cell">-->
                    <!--<div class="weui-actionsheet__cell" @click="is_show_menu=false">取消</div>-->
                <!--</div>-->
            <!--</modal>-->
        <!--</transition>-->


    </div>

    <!--下面的滑动窗口暂时不用了，编辑department是跳转到其他tab页面进行编辑-->
    <!--<transition name="slide">-->
        <!--<div v-show="crt_view=='editor'" class="slide-win">-->
            <!--&lt;!&ndash;<scroll-wraper ref="editor_scroller" style="width:100vw;height:90vh;">&ndash;&gt;-->
            <!--<title-bar :with_back="true" title="编辑部门信息"></title-bar>-->
            <!--<div class="weui-cells__title">编辑</div>-->

            <!--<div class="form-pad" >-->
                <!--<field  v-for='head in kw.heads' :key="head.name" :name='head.name' :kw='kw'></field>-->
            <!--</div>-->

            <!--<div v-btn-group>-->
                <!--<a state="success" @click="item_save()">确定</a><br/>-->
            <!--</div>-->

            <!--&lt;!&ndash;</scroll-wraper>&ndash;&gt;-->
        <!--</div>-->
    <!--</transition>-->



</div>


<style type="text/css" media="screen" id="test">

    body{
        background-color: #faf6fa;
    }


</style>


{% block extra %}
{% endblock %}
{% endblock %}